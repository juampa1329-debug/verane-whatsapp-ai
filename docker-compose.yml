services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 20

  redis:
    image: redis:7
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build: ./backend
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # ESTO FALTABA: Conecta las variables de Coolify con el contenedor
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      WHATSAPP_TOKEN: ${WHATSAPP_TOKEN}
      WHATSAPP_PHONE_NUMBER_ID: ${WHATSAPP_PHONE_NUMBER_ID}
      WHATSAPP_VERIFY_TOKEN: ${WHATSAPP_VERIFY_TOKEN}
      WC_BASE_URL: ${WC_BASE_URL}
      WC_CONSUMER_KEY: ${WC_CONSUMER_KEY}
      WC_CONSUMER_SECRET: ${WC_CONSUMER_SECRET}
    expose:
      - "8000"
    labels:
      - traefik.enable=true
      - traefik.http.routers.verane_api_http.rule=Host(`backend.perfumesverane.com`)
      - traefik.http.routers.verane_api_http.entrypoints=http
      - traefik.http.routers.verane_api_http.middlewares=verane_redirect_https,verane_api_cors
      - traefik.http.middlewares.verane_redirect_https.redirectscheme.scheme=https
      - traefik.http.routers.verane_api_https.rule=Host(`backend.perfumesverane.com`)
      - traefik.http.routers.verane_api_https.entrypoints=https
      - traefik.http.routers.verane_api_https.tls=true
      - traefik.http.routers.verane_api_https.tls.certresolver=letsencrypt
      - traefik.http.routers.verane_api_https.middlewares=verane_api_cors
      - traefik.http.services.verane_api.loadbalancer.server.port=8000
      - traefik.http.middlewares.verane_api_cors.headers.accessControlAllowOriginList=https://app.perfumesverane.com
      - traefik.http.middlewares.verane_api_cors.headers.accessControlAllowMethods=GET,POST,PUT,PATCH,DELETE,OPTIONS
      - traefik.http.middlewares.verane_api_cors.headers.accessControlAllowHeaders=*
      - traefik.http.middlewares.verane_api_cors.headers.accessControlAllowCredentials=false
      - traefik.http.middlewares.verane_api_cors.headers.addVaryHeader=true


  frontend:
    build: ./frontend
    depends_on:
      - api
    expose:
      - "80"
    labels:
      - traefik.enable=true
      - traefik.http.routers.verane_front_http.rule=Host(`app.perfumesverane.com`)
      - traefik.http.routers.verane_front_http.entrypoints=http
      - traefik.http.routers.verane_front_http.middlewares=verane_front_redirect_https
      - traefik.http.middlewares.verane_front_redirect_https.redirectscheme.scheme=https
      - traefik.http.routers.verane_front_https.rule=Host(`app.perfumesverane.com`)
      - traefik.http.routers.verane_front_https.entrypoints=https
      - traefik.http.routers.verane_front_https.tls=true
      - traefik.http.routers.verane_front_https.tls.certresolver=letsencrypt
      - traefik.http.services.verane_front.loadbalancer.server.port=80

  ai:
    build: ./ai-service
    depends_on:
      - api
    environment:
      BACKEND_BASE_URL: "http://api:8000"
      AI_ENABLED: "true"
      AI_ALLOWLIST: ""
    expose:
      - "9000"

volumes:
  pgdata: {}